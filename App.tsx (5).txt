
import React, { useState, useCallback, useEffect } from 'react';
import { Header } from './lib/Header';
import { Footer } from './lib/Footer';
import { Home } from './Home';
import { ProductsPage } from './lib/contexts/ProductsPage';
import { CartPage } from './lib/CartPage';
import { LoginPage } from './lib/vip/LoginPage';
import { DashboardPage } from './DashboardPage';
import { VipLoginPage } from './VipLoginPage';
import { VipDashboardPage } from './VipDashboardPage';
import { LoadingSpinner } from './lib/LoadingSpinner';
import { PrivacyPolicyPage } from './lib/PrivacyPolicyPage';
import { CartItem, Product, User, Page, ShowroomItem, Review, PromotionalAd, CategoryConfig, CategoryKey } from '../types';
import { I18nProvider, GeminiAiProvider, useI18n } from './lib/contexts/I18nContext';
import { ToastProvider, useToast } from './ToastContext';
import { ToastContainer } from './ToastContainer';
import { mockProducts, mockReviews } from './lib/vip/products';
import { mockInvoices, mockPayments, mockVipClients, mockTransactions } from './lib/contexts/accounting';
import { WhatsappIcon } from './lib/contexts/Icons';
import { ShowroomPage } from './ShowroomPage';
import { COMPANY_INFO, DEFAULT_SHOWROOM_ITEMS } from './constants';
import { ProductDetailPage } from './lib/ProductDetailPage';
import { ErrorBoundary } from './ErrorBoundary';
import { AiAssistant } from './AiAssistant';

const APP_VERSION = '6.1.1-title-update';

function MainApp() {
  const { language, t } = useI18n();
  const { addToast } = useToast();

  const [currentPage, setCurrentPage] = useState<Page>(() => {
    const saved = localStorage.getItem('delta-page-v6');
    return (saved as Page) || 'home';
  });

  const [products, setProducts] = useState<Product[]>(() => {
    const saved = localStorage.getItem('delta-products-v6');
    return saved ? JSON.parse(saved) : mockProducts;
  });

  const [selectedCategory, setSelectedCategory] = useState<string>('all');

  const [categories, setCategories] = useState<CategoryConfig[]>(() => {
    const saved = localStorage.getItem('delta-categories-v6');
    if (saved) return JSON.parse(saved);
    return [
        { key: 'fruits', label_ar: 'ÙÙˆØ§ÙƒÙ‡ Ø·Ø§Ø²Ø¬Ø©', label_en: 'Fresh Fruits', icon: 'ğŸ', order: 1, isVisible: true },
        { key: 'vegetables', label_ar: 'Ø®Ø¶Ø±ÙˆØ§Øª', label_en: 'Vegetables', icon: 'ğŸ¥¦', order: 2, isVisible: true },
        { key: 'herbs', label_ar: 'ÙˆØ±Ù‚ÙŠØ§Øª', label_en: 'Leafy Greens', icon: 'ğŸŒ¿', order: 3, isVisible: true },
        { key: 'qassim', label_ar: 'Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚ØµÙŠÙ…', label_en: 'Qassim Products', icon: 'ğŸŒ¾', order: 4, isVisible: true },
        { key: 'dates', label_ar: 'ØªÙ…ÙˆØ± ÙØ§Ø®Ø±Ø©', label_en: 'Premium Dates', icon: 'ğŸŒ´', order: 5, isVisible: true },
        { key: 'packages', label_ar: 'Ù‚Ø³Ù… Ø§Ù„Ø¨ÙƒØ¬Ø§Øª (Ø§Ù„ØªØºÙ„ÙŠÙ)', label_en: 'Packaging & Bundles', icon: 'ğŸ“¦', order: 6, isVisible: true },
        { key: 'seasonal', label_ar: 'Ø£ØµÙ†Ø§Ù Ù…ÙˆØ³Ù…ÙŠØ©', label_en: 'Seasonal', icon: 'â³', order: 7, isVisible: true },
        { key: 'nuts', label_ar: 'Ù…ÙƒØ³Ø±Ø§Øª', label_en: 'Nuts', icon: 'ğŸ¥œ', order: 8, isVisible: true },
        { key: 'flowers', label_ar: 'ÙˆØ±ÙˆØ¯ ÙˆÙ‡Ø¯Ø§ÙŠØ§', label_en: 'Flowers & Gifts', icon: 'ğŸŒ¸', order: 9, isVisible: true }
    ];
  });

  const [showroomItems, setShowroomItems] = useState<ShowroomItem[]>(() => {
    const saved = localStorage.getItem('delta-showroom-v6');
    return saved ? JSON.parse(saved) : DEFAULT_SHOWROOM_ITEMS;
  });

  const [promotions, setPromotions] = useState<PromotionalAd[]>(() => {
    const saved = localStorage.getItem('delta-promos-v6');
    if (saved) return JSON.parse(saved);
    return [
      { 
          id: 'promo-vip-evergreen', 
          title_ar: 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª (VIP)', 
          title_en: 'Corporate VIP Portal', 
          description_ar: 'Ù†Ø¸Ø§Ù… ØªÙˆØ±ÙŠØ¯ Ø°ÙƒÙŠ ÙˆØ´Ø§Ù…Ù„ Ù„Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©.',
          description_en: 'Comprehensive smart supply system for hotels and corporations.',
          image: 'https://images.unsplash.com/photo-1624513142340-96d5570df44d?q=80&w=1200',
          link: '#', type: 'hero', isActive: true
      },
      { 
          id: 'promo-dates-evergreen', 
          title_ar: 'ØªÙ…ÙˆØ± Ø¯Ù„ØªØ§ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', 
          title_en: 'Delta Royal Dates', 
          image: 'https://images.unsplash.com/photo-1630138243676-e1792942049e?q=80&w=1200',
          link: '#', type: 'grid', isActive: true
      }
    ];
  });

  const [cart, setCart] = useState<CartItem[]>([]);
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [selectedProductId, setSelectedProductId] = useState<number | null>(null);

  useEffect(() => {
    localStorage.setItem('delta-products-v6', JSON.stringify(products));
    localStorage.setItem('delta-categories-v6', JSON.stringify(categories));
    localStorage.setItem('delta-showroom-v6', JSON.stringify(showroomItems));
    localStorage.setItem('delta-promos-v6', JSON.stringify(promotions));
    localStorage.setItem('delta-page-v6', currentPage);
  }, [products, categories, showroomItems, promotions, currentPage]);

  const setPage = (page: Page, productId?: number, category?: string) => {
    if (page === 'productDetail' && productId) setSelectedProductId(productId);
    if (page === 'products') {
        setSelectedCategory(category || 'all');
    }
    setCurrentPage(page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleAddToCart = (p: Product, q: number = 1) => {
    setCart(prev => {
        const exists = prev.find(i => i.id === p.id);
        if (exists) return prev.map(i => i.id === p.id ? {...i, quantity: i.quantity + q} : i);
        return [...prev, {...p, quantity: q}];
    });
    addToast(language === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©' : 'Added to Cart', 'success');
  };

  const renderPage = () => {
    switch (currentPage) {
        case 'home': 
            return <Home setPage={setPage} addToCart={handleAddToCart} products={products} promotions={promotions} categories={categories} />;
        case 'products': 
            return <ProductsPage setPage={setPage} addToCart={handleAddToCart} products={products} toggleWishlist={()=>{}} isProductInWishlist={()=>false} getAverageRating={()=>({average:5,count:1})} reviews={[]} initialCategory={selectedCategory} />;
        case 'showroom': 
            return <ShowroomPage items={showroomItems} showroomBanner={COMPANY_INFO.wide_banner_url} setPage={setPage} />;
        case 'dashboard': 
            return (
                <DashboardPage 
                    user={currentUser} 
                    products={products} 
                    showroomItems={showroomItems} 
                    promotions={promotions} 
                    categoryConfigs={categories}
                    onUpdateProduct={async (p) => { setProducts(prev => prev.map(old => old.id === p.id ? p : old)); return p; }}
                    onAddProduct={async (p) => { setProducts(prev => [p, ...prev]); return p; }}
                    onDeleteProduct={async (id) => { setProducts(prev => prev.filter(p => p.id !== id)); return true; }}
                    onSetShowroomItems={setShowroomItems}
                    onSetPromotions={setPromotions}
                    onSetCategoryConfigs={setCategories}
                    setPage={setPage}
                    invoices={mockInvoices}
                    payments={[]}
                    vipClients={mockVipClients}
                    transactions={mockTransactions}
                    onAddPayment={()=>{}}
                    onAddVipClient={async (c)=>c}
                    onUpdateVipClient={async (c)=>c}
                    onDeleteVipClient={async ()=>true}
                    categoryOrder={categories.map(c => c.key)}
                    onThemeChange={()=>{}}
                    currentTheme={{}}
                />
            );
        case 'login': 
            return <LoginPage onLogin={async (c)=>{if(c.password==='12345'){setCurrentUser({type:'developer', email:c.email}); setPage('dashboard'); return {success:true}} return {success:false}}} setPage={setPage} />;
        case 'vipLogin': 
            return <VipLoginPage onLogin={async (c)=>{if(c.password==='vip'){setCurrentUser({type:'vip', phone:c.phone, name:'ÙÙ†Ø¯Ù‚ Ø¯Ù„ØªØ§ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ'}); setPage('vipDashboard'); return {success:true}} return {success:false}}} setPage={setPage} />;
        case 'vipDashboard':
            return <VipDashboardPage user={currentUser} onLogout={()=>{setCurrentUser(null); setPage('home')}} products={products} addToCart={handleAddToCart} invoices={mockInvoices} transactions={mockTransactions} setPage={setPage} />;
        case 'productDetail': {
            const p = products.find(p => p.id === selectedProductId) || products[0];
            return <ProductDetailPage product={p} setPage={setPage} reviews={[]} onAddReview={()=>{}} addToCart={(prod) => handleAddToCart(prod, 1)} averageRating={{average:5,count:1}} />;
        }
        case 'cart':
            return <CartPage cart={cart} removeFromCart={(id)=>setCart(prev => prev.filter(i=>i.id!==id))} updateQuantity={(id,q)=>setCart(prev => prev.map(i=>i.id===id?{...i,quantity:Math.max(1,q)}:i))} clearCart={()=>setCart([])} setPage={setPage} addPurchaseHistory={()=>{}} />;
        case 'privacy':
            return <PrivacyPolicyPage />;
        default: 
            return <Home setPage={setPage} addToCart={handleAddToCart} products={products} promotions={promotions} categories={categories} />;
    }
  };

  return (
    <div className="bg-gray-50 min-h-screen flex flex-col page-transition selection:bg-primary selection:text-white">
      <Header setPage={setPage} cartItemCount={cart.length} wishlistItemCount={0} user={currentUser} onLogout={()=>{setCurrentUser(null); setPage('home')}} onToggleAiAssistant={()=>{}} />
      <main className="flex-grow">{renderPage()}</main>
      <Footer setPage={setPage} />
      <a href={`https://wa.me/${COMPANY_INFO.whatsapp}`} target="_blank" className="fixed bottom-10 left-10 z-[100] bg-green-500 text-white p-10 rounded-full shadow-2xl hover:scale-110 transition-all"><WhatsappIcon className="w-10 h-10" /></a>
    </div>
  );
}

export default function App() {
  return (
    <ErrorBoundary>
      <I18nProvider>
        <ToastProvider>
          <GeminiAiProvider>
            <MainApp />
            <ToastContainer />
          </GeminiAiProvider>
        </ToastProvider>
      </I18nProvider>
    </ErrorBoundary>
  );
}
